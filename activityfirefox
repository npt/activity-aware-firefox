#!/bin/bash
#
# Compatability for Firefox and KDE Plasma Activities
#
# SPDX-License-Identifier: CC0-1.0
# SPDX-FileCopyrightText: © 2021 Matija Šuklje <matija@suklje.name>


ACTIVITY=$(qdbus org.kde.ActivityManager /ActivityManager/Activities CurrentActivity)
## Activity name if it is preferred to be used
ACTIVITY_NAME=$(qdbus org.kde.ActivityManager /ActivityManager/Activities ActivityName $ACTIVITY)
## Edit to where the profiles are to be stored and used
FF_FOLDER=$"$HOME/.mozilla/firefox"
## Default profile
DEF_PROF=$"$FF_FOLDER/????????.default-release"
if [ ! -d $DEF_PROF ]; then
	DEF_PROF=$"$FF_FOLDER/????????.default"
	if [ ! -d $DEF_PROF ]; then
		echo ">>> Could not locate the default profile"
		exit 1
	fi
fi
## Template profile if used for copying. Can override to your custom setup
TMPL_PROF=$DEF_PROF
## The profile of the current activity if one has been generated already
## ? indicate randomly generated names generate by firefox
NEW_PROF=$"$FF_FOLDER/????????.$ACTIVITY"
## Flag for copying all from template profile
FLAG_COPY_ALL=FALSE

FF_BIN=$(which firefox)
## Not the securest way to check for firefox existence but it does its job
if [ $? -ne 0 ]; then
	echo ">>> Could not locate the firefox executable"
	exit 1
fi

if [ -d $NEW_PROF ]; then
	## A profile is already found
	exec $FF_BIN --profile $NEW_PROF "$@" &
	echo ">>> Started an existing profile: $ACTIVITY_NAME"
else
	## Preferably name the profile as well, but it would bypass firefox's random name generation
# 	$FF_BIN --createprofile "$ACTIVITY_NAME $FF_FOLDER/????????.$ACTIVITY"
	$FF_BIN --createprofile $ACTIVITY
	## TODO: Rename the profile to "Activity-$ACTIVITY_NAME" (Metadata is in $FF_FOLDER/profiles.ini)
	echo ">>> Created a new profile: $ACTIVITY_NAME"
	NEW_PROF=$"$FF_FOLDER/????????.$ACTIVITY"
	if [ $FLAG_COPY_ALL = TRUE ]; then
		cp -a $TPL_PROF/* $NEW_PROF/
		echo ">>> Copied all from template profile"
	elif [ -d $DEF_PROF/chrome ]; then
		cp -a $DEF_PROF/chrome $NEW_PROF/ # copy any custom user chrome, e.g. needed to hide the top tab-bar
		echo ">>> Copied user chrome from default profile"
	fi
	exec $FF_BIN --profile $NEW_PROF "$@" &
	echo ">>> Started the new profile: $ACTIVITY_NAME"
fi

exit
